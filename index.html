<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resistencia Saludable App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        :root {
            --primary: #22c55e;
            --secondary: #3b82f6;
            --accent: #f59e0b;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            overflow-x: hidden;
        }

        .lettering-title {
            font-family: 'Dancing Script', cursive;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.7);
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.04);
        }

        .nav-tab {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-tab.active {
            color: var(--primary);
            transform: translateY(-4px);
        }

        .victory-bubble {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .victory-bubble:active {
            transform: scale(0.85);
        }

        .floating-action {
            box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3);
        }

        .shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
        }

        @keyframes shimmer {
            to { background-position: -200% 0; }
        }

        .page-section {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .page-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .log-timeline {
            position: relative;
            padding-left: 0.75rem;
            border-left: 2px solid #f1f5f9;
        }
        
        .log-dot {
            position: absolute;
            left: -5px;
            top: 6px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #cbd5e1;
        }

        .roberto-dot { background: #3b82f6; }
        .helena-dot { background: #10b981; }

        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5);
        }
    </style>
</head>
<body class="pb-24">

    <!-- Header Fijo -->
    <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-md px-6 py-4 flex justify-between items-center border-b border-slate-100">
        <div>
            <h1 class="lettering-title text-3xl">Resistencia</h1>
            <p class="text-[10px] uppercase tracking-[0.2em] font-extrabold text-slate-400 -mt-1">Roberto & Helena</p>
        </div>
        <button onclick="generateMotivation()" class="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center animate-pulse">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
        </button>
    </header>

    <main class="px-5 mt-6">
        
        <!-- SECCIÓN: TABLERO PRINCIPAL -->
        <section id="section-home" class="page-section active space-y-6">
            
            <!-- Widget de IA Personalizado con tuteo y variedad -->
            <div id="ai-motivation-card" class="glass-card p-5 bg-gradient-to-br from-amber-50 to-orange-50 border-amber-100 hidden">
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-amber-400 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-amber-200">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div>
                        <h4 class="text-xs font-black text-amber-800 uppercase tracking-wider mb-1">Tu Coach IA</h4>
                        <p id="ai-motivation-text" class="text-sm text-amber-900 leading-snug italic font-medium"></p>
                    </div>
                </div>
            </div>

            <!-- Resumen de Progreso -->
            <div class="glass-card p-6">
                <div class="flex justify-between items-end mb-6">
                    <h3 class="font-extrabold text-slate-800 tracking-tight">Estatus Semanal</h3>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Meta: 30</span>
                </div>
                
                <div class="space-y-5">
                    <div>
                        <div class="flex justify-between text-xs font-bold mb-2">
                            <span class="text-slate-500">ROBERTO</span>
                            <span id="total-roberto" class="text-blue-600 font-extrabold">0</span>
                        </div>
                        <div class="h-3 w-full bg-slate-100 rounded-full overflow-hidden">
                            <div id="bar-roberto" class="h-full bg-gradient-to-r from-blue-400 to-blue-600 transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs font-bold mb-2">
                            <span class="text-slate-500">HELENA</span>
                            <span id="total-helena" class="text-emerald-600 font-extrabold">0</span>
                        </div>
                        <div class="h-3 w-full bg-slate-100 rounded-full overflow-hidden">
                            <div id="bar-helena" class="h-full bg-gradient-to-r from-emerald-400 to-emerald-600 transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Días -->
            <div id="days-container" class="space-y-4"></div>
        </section>

        <!-- SECCIÓN: ESTADÍSTICAS -->
        <section id="section-stats" class="page-section space-y-6">
            <div class="glass-card p-6">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="font-extrabold text-slate-800 tracking-tight flex items-center gap-2">
                            <i class="fa-solid fa-chart-line text-blue-500"></i> Evolución Semanal
                        </h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase mt-1">Roberto vs Helena</p>
                    </div>
                </div>
                <div class="w-full h-64 relative">
                    <canvas id="evolutionChart"></canvas>
                    <div id="empty-chart-msg" class="absolute inset-0 flex items-center justify-center bg-slate-50/50 rounded-xl hidden">
                        <p class="text-xs font-bold text-slate-400 italic">Archiva tu primera semana para ver datos</p>
                    </div>
                </div>
            </div>

            <div class="glass-card p-6 border-t-4 border-emerald-500">
                <h3 class="font-extrabold text-slate-800 mb-4">Acciones Globales</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="saveWeekToHistory()" class="p-4 bg-emerald-50 text-emerald-700 rounded-2xl flex flex-col items-center gap-2 transition active:scale-95">
                        <i class="fa-solid fa-box-archive text-xl"></i>
                        <span class="text-[10px] font-black uppercase">Archivar Semana</span>
                    </button>
                    <button onclick="downloadData()" class="p-4 bg-blue-50 text-blue-700 rounded-2xl flex flex-col items-center gap-2 transition active:scale-95">
                        <i class="fa-solid fa-file-export text-xl"></i>
                        <span class="text-[10px] font-black uppercase">Exportar Datos</span>
                    </button>
                </div>
                <button onclick="resetData()" class="w-full mt-3 py-3 text-slate-400 text-[10px] font-bold uppercase tracking-widest">
                    Limpiar tablero actual
                </button>
            </div>
        </section>
    </main>

    <!-- Barra Navegación -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 px-10 py-3 flex justify-between items-center z-50">
        <button onclick="switchTab('home')" id="tab-home" class="nav-tab active flex flex-col items-center gap-1">
            <i class="fa-solid fa-house-chimney text-xl"></i>
            <span class="text-[10px] font-bold uppercase tracking-tighter">Tablero</span>
        </button>
        <button onclick="switchTab('stats')" id="tab-stats" class="nav-tab flex flex-col items-center gap-1 text-slate-400">
            <i class="fa-solid fa-chart-pie text-xl"></i>
            <span class="text-[10px] font-bold uppercase tracking-tighter">Historial</span>
        </button>
    </nav>

    <!-- Modal Registro -->
    <div id="log-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center hidden p-4">
        <div class="bg-white rounded-t-[2.5rem] sm:rounded-[2.5rem] w-full max-w-sm p-8 shadow-2xl transform transition-transform duration-300 translate-y-full" id="modal-content">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6 sm:hidden"></div>
            <h3 id="modal-title" class="text-xl font-black text-slate-800 mb-6 text-center tracking-tight">Registro de Victoria</h3>
            
            <div class="space-y-5">
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">Hora del logro</label>
                    <div class="flex items-center gap-3">
                        <i class="fa-regular fa-clock text-slate-400"></i>
                        <input type="time" id="modal-time" class="w-full bg-transparent border-none p-0 text-lg font-bold text-slate-700 focus:ring-0 outline-none">
                    </div>
                </div>

                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">¿Qué tentación evitaste?</label>
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-ban text-slate-400"></i>
                        <input type="text" id="modal-desc" placeholder="Ej: Café con azúcar, Chocolate..." class="w-full bg-transparent border-none p-0 text-slate-700 placeholder-slate-300 focus:ring-0 font-medium outline-none">
                    </div>
                </div>

                <div class="flex gap-4 pt-4">
                    <button onclick="closeModal()" class="flex-1 py-4 text-slate-400 font-bold hover:text-slate-600 transition">Cancelar</button>
                    <button onclick="saveEntry()" class="flex-1 py-4 bg-emerald-500 text-white font-black rounded-2xl shadow-lg floating-action hover:bg-emerald-600 active:scale-95 transition">¡LOGRADO!</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiKey = "";
        const days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
        
        let data = {
            roberto: [0, 0, 0, 0, 0, 0, 0],
            helena: [0, 0, 0, 0, 0, 0, 0],
            logs: {
                roberto: [[], [], [], [], [], [], []],
                helena: [[], [], [], [], [], [], []]
            },
            history: []
        };

        let evolutionChart = null;
        let currentModalContext = { user: null, dayIndex: null };

        function switchTab(tab) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active', 'text-slate-400'));
            
            document.getElementById(`section-${tab}`).classList.add('active');
            const activeTab = document.getElementById(`tab-${tab}`);
            activeTab.classList.add('active');
            
            if(tab === 'stats') {
                initChart();
            } else {
                document.getElementById('tab-stats').classList.add('text-slate-400');
            }
        }

        async function callGemini(prompt, systemInstruction) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (err) { return null; }
        }

        async function generateMotivation() {
            const card = document.getElementById('ai-motivation-card');
            const text = document.getElementById('ai-motivation-text');
            card.classList.remove('hidden');
            text.innerHTML = '<span class="inline-block w-full h-4 shimmer rounded"></span>';

            const sumR = data.roberto.reduce((a, b) => a + b, 0);
            const sumH = data.helena.reduce((a, b) => a + b, 0);
            
            // Semilla aleatoria interna para evitar repeticiones en el pensamiento de la IA
            const seed = Math.floor(Math.random() * 1000);

            const prompt = `Puntaje: Roberto ${sumR}, Helena ${sumH}. Genera una frase corta de salud o reto. Contexto aleatorio id ${seed}. Si alguien va abajo, dile que espabile; si van empate, pícales.`;
            
            const system = `Eres un coach de salud que tutea siempre a Roberto y Helena. 
            REGLAS:
            1. Usa siempre el "TÚ" (tuteo). 
            2. Menciona a los dos por su nombre. 
            3. Sé ingenioso, directo y NUNCA repetitivo. 
            4. Evita frases motivacionales genéricas. 
            5. Si Roberto lleva ${sumR} y Helena ${sumH}, usa esa info para personalizar el mensaje. 
            6. Máximo 16 palabras.`;

            const msg = await callGemini(prompt, system);
            text.innerText = msg || "¡Venga, Roberto y Helena! No dejéis que esa tentación os gane hoy.";
        }

        function initChart() {
            const ctx = document.getElementById('evolutionChart').getContext('2d');
            const emptyMsg = document.getElementById('empty-chart-msg');

            if (data.history.length === 0) {
                emptyMsg.classList.remove('hidden');
                if (evolutionChart) evolutionChart.destroy();
                return;
            }
            emptyMsg.classList.add('hidden');

            if (evolutionChart) evolutionChart.destroy();

            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.history.map(h => h.range),
                    datasets: [
                        {
                            label: 'Roberto',
                            data: data.history.map(h => h.roberto),
                            borderColor: '#3b82f6',
                            borderWidth: 4,
                            pointRadius: 4,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#3b82f6',
                            pointBorderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            backgroundColor: (context) => {
                                const ctx = context.chart.ctx;
                                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
                                gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                                return gradient;
                            }
                        },
                        {
                            label: 'Helena',
                            data: data.history.map(h => h.helena),
                            borderColor: '#10b981',
                            borderWidth: 4,
                            pointRadius: 4,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#10b981',
                            pointBorderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            backgroundColor: (context) => {
                                const ctx = context.chart.ctx;
                                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                                gradient.addColorStop(0, 'rgba(16, 185, 129, 0.2)');
                                gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');
                                return gradient;
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { usePointStyle: true, font: { size: 10, weight: '800' }, padding: 20 } 
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { font: { size: 10 } } },
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        function openModal(user, dayIndex) {
            currentModalContext = { user, dayIndex };
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            document.getElementById('modal-time').value = currentTime;
            document.getElementById('modal-desc').value = '';
            document.getElementById('modal-title').innerHTML = `Victoria de <span class="${user === 'roberto' ? 'text-blue-500' : 'text-emerald-500'}">${user.toUpperCase()}</span>`;
            
            const modal = document.getElementById('log-modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => content.classList.remove('translate-y-full'), 10);
        }

        function closeModal() {
            const content = document.getElementById('modal-content');
            content.classList.add('translate-y-full');
            setTimeout(() => document.getElementById('log-modal').classList.add('hidden'), 300);
        }

        function saveEntry() {
            const { user, dayIndex } = currentModalContext;
            const time = document.getElementById('modal-time').value;
            const desc = document.getElementById('modal-desc').value.trim() || "Resistencia";
            
            data[user][dayIndex]++;
            data.logs[user][dayIndex].push({ time, desc });
            saveData();
            renderDays();
            closeModal();
        }

        function removeVictory(user, dayIndex) {
            if (data[user][dayIndex] > 0) {
                if(confirm(`¿Eliminar la última victoria de ${user}?`)) {
                    data[user][dayIndex]--;
                    data.logs[user][dayIndex].pop();
                    saveData();
                    renderDays();
                }
            }
        }

        function updateStats() {
            const sumR = data.roberto.reduce((a, b) => a + b, 0);
            const sumH = data.helena.reduce((a, b) => a + b, 0);
            document.getElementById('total-roberto').innerText = sumR;
            document.getElementById('total-helena').innerText = sumH;
            const goal = 30;
            document.getElementById('bar-roberto').style.width = Math.min((sumR / goal) * 100, 100) + '%';
            document.getElementById('bar-helena').style.width = Math.min((sumH / goal) * 100, 100) + '%';
        }

        function renderDays() {
            const container = document.getElementById('days-container');
            container.innerHTML = '';

            days.forEach((day, idx) => {
                const card = document.createElement('div');
                card.className = 'glass-card p-5';
                
                const buildLogTimeline = (user) => {
                    const list = data.logs[user][idx];
                    if (list.length === 0) return '<p class="text-[10px] text-slate-300 italic mt-2">Sin registros</p>';
                    return `
                        <div class="mt-4 space-y-3 log-timeline">
                            ${list.map(l => `
                                <div class="relative pl-3">
                                    <div class="log-dot ${user}-dot"></div>
                                    <div class="flex flex-col">
                                        <span class="text-[9px] font-black text-slate-400 uppercase leading-none">${l.time}</span>
                                        <span class="text-[11px] font-semibold text-slate-700 leading-tight mt-1">${l.desc}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                };

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-5">
                        <h4 class="font-extrabold text-slate-800 text-sm tracking-tight">${day}</h4>
                        <div class="h-px flex-1 bg-slate-100 mx-4"></div>
                        <i class="fa-solid fa-calendar-day text-slate-200 text-xs"></i>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-8">
                        <div class="flex flex-col">
                            <div class="flex items-center justify-between mb-3 bg-blue-50/50 p-2 rounded-2xl">
                                <button onclick="removeVictory('roberto', ${idx})" class="w-7 h-7 rounded-xl bg-white text-blue-300 flex items-center justify-center text-xs shadow-sm">-</button>
                                <button onclick="openModal('roberto', ${idx})" class="victory-bubble w-10 h-10 rounded-xl bg-blue-600 text-white flex items-center justify-center shadow-lg shadow-blue-200">
                                    <span class="text-base font-black">${data.roberto[idx]}</span>
                                </button>
                                <button onclick="openModal('roberto', ${idx})" class="w-7 h-7 rounded-xl bg-white text-blue-500 flex items-center justify-center text-xs shadow-sm">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                            <span class="text-[9px] font-black text-blue-500 uppercase tracking-widest text-center">ROBERTO</span>
                            ${buildLogTimeline('roberto')}
                        </div>

                        <div class="flex flex-col">
                            <div class="flex items-center justify-between mb-3 bg-emerald-50/50 p-2 rounded-2xl">
                                <button onclick="removeVictory('helena', ${idx})" class="w-7 h-7 rounded-xl bg-white text-emerald-300 flex items-center justify-center text-xs shadow-sm">-</button>
                                <button onclick="openModal('helena', ${idx})" class="victory-bubble w-10 h-10 rounded-xl bg-emerald-600 text-white flex items-center justify-center shadow-lg shadow-emerald-200">
                                    <span class="text-base font-black">${data.helena[idx]}</span>
                                </button>
                                <button onclick="openModal('helena', ${idx})" class="w-7 h-7 rounded-xl bg-white text-emerald-500 flex items-center justify-center text-xs shadow-sm">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                            <span class="text-[9px] font-black text-emerald-500 uppercase tracking-widest text-center">HELENA</span>
                            ${buildLogTimeline('helena')}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            updateStats();
        }

        function saveData() {
            localStorage.setItem('res_saludable_mobile_v4', JSON.stringify(data));
            updateStats();
        }

        function loadData() {
            const saved = localStorage.getItem('res_saludable_mobile_v4');
            if (saved) data = JSON.parse(saved);
            renderDays();
            if (document.getElementById('section-stats').classList.contains('active')) initChart();
        }

        function saveWeekToHistory() {
            const sumR = data.roberto.reduce((a, b) => a + b, 0);
            const sumH = data.helena.reduce((a, b) => a + b, 0);
            if (sumR === 0 && sumH === 0) return;
            const now = new Date();
            const rangeStr = `${now.getDate()}/${now.getMonth() + 1}`;
            data.history.push({ range: rangeStr, roberto: sumR, helena: sumH });
            if (data.history.length > 10) data.history.shift();
            data.roberto = [0, 0, 0, 0, 0, 0, 0];
            data.helena = [0, 0, 0, 0, 0, 0, 0];
            data.logs = { roberto: [[],[],[],[],[],[],[]], helena: [[],[],[],[],[],[],[]] };
            saveData();
            renderDays();
            switchTab('stats');
        }

        function downloadData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'datos-resistencia.json';
            a.click();
        }

        function resetData() {
            if(confirm('¿Borrar semana actual?')) {
                data.roberto = [0, 0, 0, 0, 0, 0, 0];
                data.helena = [0, 0, 0, 0, 0, 0, 0];
                data.logs = { roberto: [[],[],[],[],[],[],[]], helena: [[],[],[],[],[],[],[]] };
                saveData();
                renderDays();
            }
        }

        window.onload = loadData;
    </script>
</body>
</html>