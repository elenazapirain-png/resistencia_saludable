<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resistencia Saludable Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'resistencia-compartida';

        let state = {
            roberto: [0, 0, 0, 0, 0, 0, 0],
            helena: [0, 0, 0, 0, 0, 0, 0],
            logs: {
                roberto: [[], [], [], [], [], [], []],
                helena: [[], [], [], [], [], [], []]
            },
            history: []
        };

        async function initApp() {
            window.renderApp(state);
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (user) => {
                    if (user) subscribeToData();
                });
            } catch (error) {
                console.error("Error Auth:", error);
            }
        }

        function subscribeToData() {
            if (!auth.currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shared', 'globalState');
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (typeof data.logs === 'string') {
                        data.logs = JSON.parse(data.logs);
                    }
                    state = data;
                    window.renderApp(state);
                } else {
                    saveToCloud(state);
                }
            }, (error) => {
                console.error("Error Firestore:", error);
            });
        }

        async function saveToCloud(newState) {
            if (!auth.currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shared', 'globalState');
            const dataToSave = {
                ...newState,
                logs: JSON.stringify(newState.logs)
            };
            try {
                await setDoc(docRef, dataToSave);
            } catch (error) {
                console.error("Error al guardar:", error);
            }
        }

        window.saveToCloud = saveToCloud;
        window.initApp = initApp;
        window.addEventListener('load', initApp);
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        :root { --primary: #22c55e; --secondary: #3b82f6; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .lettering-title { font-family: 'Dancing Script', cursive; background: linear-gradient(135deg, #059669 0%, #10b981 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .glass-card { background: white; border-radius: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid #f1f5f9; }
        .nav-tab.active { color: var(--primary); }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .btn-action { transition: transform 0.1s ease; }
        .btn-action:active { transform: scale(0.92); }
        .btn-minus { width: 22px; height: 22px; border-radius: 6px; background: #fee2e2; color: #ef4444; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .current-day { border: 2px solid #22c55e; position: relative; }
        .current-day::after { content: 'HOY'; position: absolute; top: -8px; left: 12px; background: #22c55e; color: white; font-size: 8px; font-weight: 800; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body class="pb-24">

    <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-md px-6 py-4 flex justify-between items-center border-b border-slate-100">
        <div>
            <h1 class="lettering-title text-3xl">Resistencia</h1>
            <p class="text-[10px] uppercase font-bold text-slate-400 tracking-widest">Roberto & Helena</p>
        </div>
        <button onclick="generateMotivation()" class="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center btn-action shadow-sm">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
        </button>
    </header>

    <main class="px-5 mt-6">
        <section id="section-home" class="page-section active space-y-6">
            <div id="ai-motivation-card" class="glass-card p-5 bg-gradient-to-br from-amber-50 to-orange-50 border-amber-100 hidden">
                <div class="flex gap-4">
                    <div class="w-10 h-10 bg-amber-400 rounded-xl flex items-center justify-center text-white shrink-0">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <p id="ai-motivation-text" class="text-sm text-amber-900 leading-snug font-medium italic"></p>
                </div>
            </div>

            <div class="glass-card p-6">
                <h3 class="font-extrabold text-slate-800 mb-4 text-xs uppercase tracking-tight">Evolución de la Semana</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-[11px] font-bold mb-1">
                            <span class="text-blue-500 uppercase">Roberto</span>
                            <span id="total-roberto">0</span>
                        </div>
                        <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                            <div id="bar-roberto" class="h-full bg-blue-500 transition-all duration-700 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] font-bold mb-1">
                            <span class="text-emerald-500 uppercase">Helena</span>
                            <span id="total-helena">0</span>
                        </div>
                        <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                            <div id="bar-helena" class="h-full bg-emerald-500 transition-all duration-700 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="days-container" class="space-y-3"></div>
        </section>

        <section id="section-stats" class="page-section space-y-6">
            <div class="glass-card p-6">
                <h3 class="font-extrabold text-slate-800 mb-4">Progreso Histórico</h3>
                <div class="h-64">
                    <canvas id="evolutionChart"></canvas>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="window.saveWeekToHistory()" class="flex-1 py-4 bg-emerald-500 text-white font-black rounded-2xl shadow-lg btn-action">Archivar Semana</button>
                <button onclick="window.resetCurrentData()" class="flex-1 py-4 bg-white text-slate-400 font-bold rounded-2xl border border-slate-200 btn-action">Reiniciar</button>
            </div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-slate-100 px-12 py-4 flex justify-between items-center z-50">
        <button onclick="switchTab('home')" id="tab-home" class="nav-tab active flex flex-col items-center gap-1 btn-action">
            <i class="fa-solid fa-calendar-check text-xl"></i>
            <span class="text-[10px] font-bold uppercase">Registro</span>
        </button>
        <button onclick="switchTab('stats')" id="tab-stats" class="nav-tab flex flex-col items-center gap-1 text-slate-300 btn-action">
            <i class="fa-solid fa-chart-line text-xl"></i>
            <span class="text-[10px] font-bold uppercase">Datos</span>
        </button>
    </nav>

    <div id="log-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] flex items-end justify-center hidden p-4">
        <div class="bg-white rounded-t-[2.5rem] w-full max-w-md p-8 transform transition-transform duration-300 translate-y-full" id="modal-content">
            <h3 class="text-xl font-black mb-6 text-center text-slate-800">Nueva Victoria</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">¿Qué has evitado?</label>
                    <input type="text" id="modal-desc" placeholder="Ej: Bollería industrial" class="w-full bg-slate-50 p-4 mt-1 rounded-2xl border-none outline-none focus:ring-2 focus:ring-emerald-500 transition-all text-slate-700">
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="closeModal()" class="flex-1 py-4 text-slate-400 font-bold">Cancelar</button>
                    <button onclick="saveEntry()" class="flex-1 py-4 bg-emerald-500 text-white font-black rounded-2xl shadow-md">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const dayNames = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
        let currentData = null;
        let currentModalContext = { user: null, dayIndex: null };
        let evolutionChart = null;
        const apiKey = "";

        // Obtener las fechas de la semana actual (Lunes a Domingo)
        function getWeekDates() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 (Dom) a 6 (Sab)
            const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Ajustar para que empiece el Lunes
            const monday = new Date(now.setDate(diff));
            
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const tempDate = new Date(monday);
                tempDate.setDate(monday.getDate() + i);
                dates.push(tempDate);
            }
            return dates;
        }

        window.renderApp = (state) => {
            currentData = state;
            const container = document.getElementById('days-container');
            if (!container) return;
            container.innerHTML = '';

            const weekDates = getWeekDates();
            const today = new Date().toDateString();

            dayNames.forEach((day, idx) => {
                const dateObj = weekDates[idx];
                const dateFormatted = `${dateObj.getDate()}/${dateObj.getMonth() + 1}`;
                const isToday = dateObj.toDateString() === today;

                const card = document.createElement('div');
                card.className = `glass-card p-4 flex items-center justify-between ${isToday ? 'current-day' : ''}`;
                card.innerHTML = `
                    <div class="flex flex-col">
                        <h4 class="font-black text-slate-800 text-xs">${day}</h4>
                        <span class="text-[10px] text-slate-400 font-medium">${dateFormatted}</span>
                    </div>
                    <div class="flex gap-6 items-center">
                        <div class="flex items-center gap-2">
                            <div class="flex flex-col items-center gap-1">
                                <button onclick="openModal('roberto', ${idx})" class="w-11 h-11 rounded-full bg-blue-50 text-blue-600 font-black border-2 border-blue-100 flex items-center justify-center btn-action">
                                    ${currentData.roberto[idx]}
                                </button>
                                <span class="text-[8px] font-bold text-slate-400 uppercase">Rob</span>
                            </div>
                            <button onclick="removeEntry('roberto', ${idx})" class="btn-minus btn-action"><i class="fa-solid fa-minus"></i></button>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="flex flex-col items-center gap-1">
                                <button onclick="openModal('helena', ${idx})" class="w-11 h-11 rounded-full bg-emerald-50 text-emerald-600 font-black border-2 border-emerald-100 flex items-center justify-center btn-action">
                                    ${currentData.helena[idx]}
                                </button>
                                <span class="text-[8px] font-bold text-slate-400 uppercase">Hel</span>
                            </div>
                            <button onclick="removeEntry('helena', ${idx})" class="btn-minus btn-action"><i class="fa-solid fa-minus"></i></button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            const sumR = currentData.roberto.reduce((a, b) => a + b, 0);
            const sumH = currentData.helena.reduce((a, b) => a + b, 0);
            document.getElementById('total-roberto').innerText = sumR;
            document.getElementById('total-helena').innerText = sumH;
            document.getElementById('bar-roberto').style.width = Math.min((sumR / 35) * 100, 100) + '%';
            document.getElementById('bar-helena').style.width = Math.min((sumH / 35) * 100, 100) + '%';
        };

        function switchTab(tab) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active', 'text-slate-300'));
            document.getElementById(`section-${tab}`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            if(tab === 'stats') initChart();
        }

        function openModal(user, idx) {
            currentModalContext = { user, dayIndex: idx };
            document.getElementById('modal-desc').value = '';
            document.getElementById('log-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-content').classList.remove('translate-y-full'), 10);
        }

        function closeModal() {
            document.getElementById('modal-content').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('log-modal').classList.add('hidden'), 300);
        }

        function saveEntry() {
            const { user, dayIndex } = currentModalContext;
            const desc = document.getElementById('modal-desc').value || "Victoria";
            const timeString = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            currentData[user][dayIndex]++;
            currentData.logs[user][dayIndex].push({
                time: timeString,
                desc: desc
            });
            window.saveToCloud(currentData);
            closeModal();
            window.renderApp(currentData);
        }

        function removeEntry(user, idx) {
            if (currentData[user][idx] > 0) {
                currentData[user][idx]--;
                currentData.logs[user][idx].pop();
                window.saveToCloud(currentData);
                window.renderApp(currentData);
            }
        }

        window.resetCurrentData = () => {
            if(!confirm("¿Reiniciar semana?")) return;
            currentData.roberto = [0,0,0,0,0,0,0];
            currentData.helena = [0,0,0,0,0,0,0];
            currentData.logs = { roberto: [[],[],[],[],[],[],[]], helena: [[],[],[],[],[],[],[]] };
            window.saveToCloud(currentData);
            window.renderApp(currentData);
        };

        window.saveWeekToHistory = () => {
            const sumR = currentData.roberto.reduce((a, b) => a + b, 0);
            const sumH = currentData.helena.reduce((a, b) => a + b, 0);
            const range = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
            if (sumR === 0 && sumH === 0) return;
            currentData.history.push({ range, roberto: sumR, helena: sumH });
            currentData.roberto = [0,0,0,0,0,0,0];
            currentData.helena = [0,0,0,0,0,0,0];
            currentData.logs = { roberto: [[],[],[],[],[],[],[]], helena: [[],[],[],[],[],[],[]] };
            window.saveToCloud(currentData);
            window.renderApp(currentData);
        }

        async function generateMotivation() {
            const card = document.getElementById('ai-motivation-card');
            const text = document.getElementById('ai-motivation-text');
            card.classList.remove('hidden');
            text.innerText = "Pensando...";
            try {
                const r = currentData.roberto.reduce((a,b)=>a+b,0);
                const h = currentData.helena.reduce((a,b)=>a+b,0);
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Roberto: ${r}, Helena: ${h}. Motívales con una frase corta de salud.` }] }],
                        systemInstruction: { parts: [{ text: "Coach breve." }] }
                    })
                });
                const res = await response.json();
                text.innerText = res.candidates?.[0]?.content?.parts?.[0]?.text || "¡A por ello!";
            } catch (e) {
                text.innerText = "¡Cada esfuerzo cuenta!";
            }
        }

        function initChart() {
            const ctx = document.getElementById('evolutionChart').getContext('2d');
            if (evolutionChart) evolutionChart.destroy();
            const labels = currentData.history.length > 0 ? currentData.history.map(h => h.range) : ['-'];
            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Roberto', data: currentData.history.map(h => h.roberto), borderColor: '#3b82f6', tension: 0.3 },
                        { label: 'Helena', data: currentData.history.map(h => h.helena), borderColor: '#10b981', tension: 0.3 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>